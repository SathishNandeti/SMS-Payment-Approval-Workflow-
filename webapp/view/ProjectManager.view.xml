<mvc:View
    controllerName="com.incresol.zpaymentworkflow.controller.ProjectManager"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:table="sap.ui.table"
    xmlns:m="sap.m"
    xmlns:f="sap.f"
    displayBlock="true"
    height="100%">

    <f:DynamicPage id="idPaymentDynamicPage">

        <!-- ================= TITLE ================= -->
        <f:title>
            <f:DynamicPageTitle>
                <f:heading>
                    <m:Title text="Payment Approvals"/>
                </f:heading>
            </f:DynamicPageTitle>
        </f:title>

        <!-- ================= CONTENT ================= -->
        <f:content>
            <m:VBox
                height="100%"
                fitContainer="true"
                class="sapUiContentPadding">

                <!-- ================= ACTION BAR - MOVED TO TOP ================= -->
                <m:Toolbar class="sapUiMediumMarginBottom">
                    <!-- Currency Display Switch -->
                    <m:Label text="Show in Lakhs:" class="sapUiTinyMarginEnd"/>
                    <m:Switch
                        id="idShowInLakhsSwitch"
                        state="{viewState>/showInLakhs}"
                        change="onSwitchShowInLakhsChange"
                        tooltip="Toggle between Rupees and Lakhs view"/>
                    
                    <m:ToolbarSpacer/>
                    <m:Button
                        text="Approve"
                        type="Accept"
                        enabled="{viewState>/showBulkActions}"
                        press="onApproveButtonPress"/>
                    <m:Button
                        text="Reject"
                        type="Reject"
                        enabled="{viewState>/showBulkActions}"
                        press="onRejectButtonPress"/>
                </m:Toolbar>

                <!-- ================= TREE TABLE ================= -->
                <table:TreeTable
                    id="idTreeTable"
                    rows="{path:'treeData>/treeData', parameters:{arrayNames:['children']}}"
                    
                    selectionMode="MultiToggle"
                    selectionBehavior="Row"
                    rowSelectionChange="onTreeTableRowSelectionChange"
                    
                    fixedColumnCount="4"
                    
                    enableBusyIndicator="true"
                    width="100%"
                    class="sapUiSizeCompact">

                    <!-- ================= Approval Note No - Use direct ApprovalNo ================= -->
                    <table:Column label="Approval Note No" width="120px">
                        <table:template>
                            <m:Text
                                text="{treeData>ApprovalNo}"
                                class="{= ${treeData>isHeader} ? 'sapThemeHighlight-asTextColor' : ''}"
                                visible="{treeData>isHeader}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Date of Approval Note - Use direct binding from PaymentHeaderSet ================= -->
                    <table:Column label="Date of Approval Note" width="140px">
                        <table:template>
                            <m:Text 
                                text="{path:'treeData>DateOfApproval', type:'sap.ui.model.odata.type.DateTime', formatOptions:{pattern:'dd.MM.yyyy'}}"
                                visible="{treeData>isHeader}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Profit Center - Use direct binding from PaymentHeaderSet ================= -->
                    <table:Column label="Profit Center" width="100px">
                        <table:template>
                            <m:Text 
                                text="{treeData>ProfitCenter}"
                                visible="{treeData>isHeader}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Profit Center Name - Use direct binding from PaymentHeaderSet ================= -->
                    <table:Column label="Profit Center Name" width="150px">
                        <table:template>
                            <m:Text 
                                text="{treeData>ProfitCenterName}"
                                visible="{treeData>isHeader}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Vendor Code ================= -->
                    <table:Column label="Vendor Code" width="120px">
                        <table:template>
                            <m:VBox>
                                <!-- For header rows - not available in PaymentHeaderSet, show empty -->
                                <m:Text 
                                    text=""
                                    visible="{treeData>isHeader}"/>
                                <!-- For item rows - use PaymentItemSet VendorCode (not VendorNumber) -->
                                <m:Text 
                                    text="{treeData>VendorCode}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= Vendor Name ================= -->
                    <table:Column label="Name of Vendor" width="220px">
                        <table:template>
                            <m:VBox>
                                <!-- For header rows - not available in PaymentHeaderSet, show empty -->
                                <m:Text 
                                    text=""
                                    visible="{treeData>isHeader}"/>
                                <!-- For item rows - use PaymentItemSet VendorName -->
                                <m:Text 
                                    text="{treeData>VendorName}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= Liability Head ================= -->
                    <table:Column label="Liability Head (Dropdown)" width="180px">
                        <table:template>
                            <m:Text
                                text="{treeData>LiabHead}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Invoice Number ================= -->
                    <table:Column label="Invoice No." width="120px">
                        <table:template>
                            <m:Text
                                text="{treeData>DocNum}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Purchase Order ================= -->
                    <table:Column label="Purchase Order" width="120px">
                        <table:template>
                            <m:Text
                                text="{treeData>PurchDoc}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Document Number ================= -->
                    <table:Column label="Document Number" width="120px">
                        <table:template>
                            <m:Text
                                text="{treeData>DocNum}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Document Date ================= -->
                    <table:Column label="Document Date" width="120px">
                        <table:template>
                            <m:Text 
                                text="{path:'treeData>DocDate', type:'sap.ui.model.odata.type.DateTime', formatOptions:{pattern:'dd.MM.yyyy'}}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Posting Date ================= -->
                    <table:Column label="Posting Date" width="120px">
                        <table:template>
                            <m:Text 
                                text="{path:'treeData>PostingDt', type:'sap.ui.model.odata.type.DateTime', formatOptions:{pattern:'dd.MM.yyyy'}}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Invoice Amount ================= -->
                    <table:Column label="Invoice Amount" width="130px" hAlign="End">
                        <table:template>
                            <m:VBox>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TotalInvoiceAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{treeData>isHeader}"
                                    class="sapThemeHighlight-asTextColor"/>
                                <m:Text
                                    text="{parts: [{path: 'treeData>InvoiceAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= Base Amount ================= -->
                    <table:Column label="Base Amount" width="130px" hAlign="End">
                        <table:template>
                            <m:VBox>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TotalBaseAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{treeData>isHeader}"
                                    class="sapThemeHighlight-asTextColor"/>
                                <m:Text
                                    text="{parts: [{path: 'treeData>BaseAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= GST Amount ================= -->
                    <table:Column label="GST Amount" width="130px" hAlign="End">
                        <table:template>
                            <m:VBox>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TotalGstAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{treeData>isHeader}"
                                    class="sapThemeHighlight-asTextColor"/>
                                <m:Text
                                    text="{parts: [{path: 'treeData>GstAmt'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= TDS Amount ================= -->
                    <table:Column label="TDS Amount" width="130px" hAlign="End">
                        <table:template>
                            <m:VBox>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TotalTdsAmount'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{treeData>isHeader}"
                                    class="sapThemeHighlight-asTextColor"/>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TdsAmount'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= Total Liability ================= -->
                    <table:Column label="Total Liability" width="130px" hAlign="End">
                        <table:template>
                            <m:Text text="{parts: [{path: 'treeData>TotalLiability'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Amount Claimed ================= -->
                    <table:Column label="Amount Claimed" width="130px" hAlign="End">
                        <table:template>
                            <m:VBox>
                                <m:Text
                                    text="{parts: [{path: 'treeData>TotalAmtClaimed'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{treeData>isHeader}"
                                    class="sapThemeHighlight-asTextColor"/>
                                <m:Text
                                    text="{parts: [{path: 'treeData>AmtClaimed'}, {path: 'viewState>/showInLakhs'}], formatter: '.formatter.formatCurrency'}"
                                    visible="{= !${treeData>isHeader} }"/>
                            </m:VBox>
                        </table:template>
                    </table:Column>

                    <!-- ================= PM Status ================= -->
                    <table:Column label="PM Status" width="120px">
                        <table:template>
                            <m:ObjectStatus
                                text="{treeData>PmApprStatus}"
                                state="{path:'treeData>PmApprStatus', formatter:'.formatter.statusState'}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= HOD Status ================= -->
                    <table:Column label="HOD Status" width="120px">
                        <table:template>
                            <m:ObjectStatus
                                text="{treeData>HodApprStatus}"
                                state="{path:'treeData>HodApprStatus', formatter:'.formatter.statusState'}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= CFO Status ================= -->
                    <table:Column label="CFO Status" width="120px">
                        <table:template>
                            <m:ObjectStatus
                                text="{treeData>CfoApprStatus}"
                                state="{path:'treeData>CfoApprStatus', formatter:'.formatter.statusState'}"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Bank Name ================= -->
                    <table:Column label="Bank Name" width="200px">
                        <table:template>
                            <m:Text
                                text="{treeData>BankName}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Account Number ================= -->
                    <table:Column label="Account Number" width="160px">
                        <table:template>
                            <m:Text
                                text="{treeData>AccountNumber}"
                                visible="{= !${treeData>isHeader} }"/>
                        </table:template>
                    </table:Column>

                    <!-- ================= Currency ================= -->
                    <table:Column label="Currency" width="80px">
                        <table:template>
                            <m:Text text="{treeData>Currency}"/>
                        </table:template>
                    </table:Column>

                </table:TreeTable>
                

            </m:VBox>
        </f:content>
    </f:DynamicPage>
</mvc:View>
